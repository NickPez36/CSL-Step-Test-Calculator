<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canoe Slalom Lactate Threshold Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Regression.js for polynomial curve fitting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style for table inputs in dark mode */
        #dataTable input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            /* gray-600 */
            border-radius: 0.375rem;
            text-align: center;
            background-color: #374151;
            /* gray-700 */
            color: #f3f4f6;
            /* gray-100 */
        }

        #dataTable input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: -1px;
            border-color: #3b82f6;
        }

        #dataTable input.bg-gray-100 {
            background-color: #4b5563 !important;
            /* gray-600 */
        }

        .toggle-btn {
            transition: all 0.2s ease-in-out;
        }

        .toggle-btn-active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Canoe Slalom Lactate Threshold Calculator</h1>
            <p class="mt-2 text-lg text-gray-400">Analyze step test data to determine LT1 and LT2 thresholds.</p>
        </header>

        <!-- Athlete & Session Details -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Athlete & Session Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Athlete Name</label>
                    <input type="text" id="athleteName"
                        class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-blue-500"
                        placeholder="e.g. John Doe">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Date</label>
                    <input type="date" id="testDate"
                        class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Boat Class</label>
                    <select id="boatClass"
                        class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-blue-500">
                        <option value="K1 Men">K1 Men</option>
                        <option value="K1 Women">K1 Women</option>
                        <option value="C1 Men">C1 Men</option>
                        <option value="C1 Women">C1 Women</option>
                        <option value="Kayak Cross Men">Kayak Cross Men</option>
                        <option value="Kayak Cross Women">Kayak Cross Women</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Testing Protocol</label>
                    <input type="text" id="protocol"
                        class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-blue-500"
                        placeholder="e.g. 6x4min Step Test">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Comments</label>
                <textarea id="comments" rows="3"
                    class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-blue-500"
                    placeholder="Notes on conditions, athlete state, etc."></textarea>
            </div>
        </div>

        <!-- Input Data Section -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-2 text-white">1. Input Data</h2>

            <div class="mb-4">
                <label class="font-semibold text-gray-300">Protocol Type:</label>
                <div id="tableTypeToggle" class="mt-2 flex bg-gray-700 rounded-lg p-1 max-w-md">
                    <button data-type="hr" class="toggle-btn toggle-btn-active flex-1 py-1 px-2 text-sm rounded-md">HR
                        Based</button>
                    <button data-type="speed" class="toggle-btn flex-1 py-1 px-2 text-sm rounded-md">Speed
                        Based</button>
                    <button data-type="sr" class="toggle-btn flex-1 py-1 px-2 text-sm rounded-md">Stroke Rate
                        Based</button>
                </div>
            </div>

            <p class="text-sm text-gray-400 mb-4">You can navigate the table with arrow keys and paste data from a
                spreadsheet.</p>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full text-sm">
                    <thead class="bg-gray-700">
                        <tr id="tableHeaderRow">
                            <!-- Headers will be dynamically inserted here -->
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- Rows will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
            <div class="flex space-x-2 mt-4">
                <button id="addRowBtn"
                    class="bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-all duration-300 text-xs">Add
                    Row</button>
                <button id="removeRowBtn"
                    class="bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-all duration-300 text-xs">Remove
                    Last Row</button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mt-6">
                <button id="calculateBtn"
                    class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Calculate Thresholds & Efficiency
                </button>
                <button id="exportPdfBtn"
                    class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                    Export to PDF
                </button>
            </div>
            <div id="error" class="mt-4 text-red-400 font-medium hidden"></div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 1. Speed vs Lactate -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Lactate</h2>
                <div class="relative h-[350px]">
                    <canvas id="lactateChart"></canvas>
                </div>
            </div>
            <!-- 2. Speed vs HR -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Heart Rate</h2>
                <div class="relative h-[350px]">
                    <canvas id="hrChart"></canvas>
                </div>
            </div>
            <!-- 3. Speed vs Stroke Rate -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Stroke Rate</h2>
                <div class="relative h-[350px]">
                    <canvas id="srChart"></canvas>
                </div>
            </div>
            <!-- 4. Step Efficiency Chart -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Step Efficiency Chart</h2>
                <div class="relative h-[350px]">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Calculated Thresholds -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-white">2. Calculated Thresholds</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h3 class="font-bold text-lg text-teal-400">Lactate Threshold 1 (LT1)</h3>
                            <p class="text-sm text-gray-400 mb-2">Calculated using the Lowest Lactate + 0.4 mmol/L
                                method.</p>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                    <p id="lt1_hr" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                    <p id="lt1_speed" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Lactate (mmol/L)</p>
                                    <p id="lt1_lactate" class="text-xl font-semibold">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h3 class="font-bold text-lg text-red-400">Lactate Threshold 2 (LT2)</h3>
                            <p class="text-sm text-gray-400 mb-2">Calculated using the Modified DMax method (Bishop et
                                al., 1998).</p>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                    <p id="lt2_hr" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                    <p id="lt2_speed" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Lactate (mmol/L)</p>
                                    <p id="lt2_lactate" class="text-xl font-semibold">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Key Lactate Points -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-white">3. Key Lactate Points</h2>
                    <p class="text-sm text-gray-400 mb-4">Speed and Heart Rate values interpolated from the curve at
                        fixed lactate levels.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">2.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_2mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_2mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">4.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_4mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_4mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">6.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_6mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_6mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>


        <!-- Training Zones Table -->
        <div id="trainingZones" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">4. Training Zones</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-separate border-spacing-0 rounded-lg overflow-hidden">
                    <thead class="bg-gray-900 text-white">
                        <tr>
                            <th class="p-3 border border-gray-700 w-32">Domain</th> <!-- Intensity/Domain -->
                            <th class="p-3 border border-gray-700">Zone</th>
                            <th class="p-3 border border-gray-700">Descriptor</th>
                            <th class="p-3 border border-gray-700">Heart Rate (BPM)</th>
                            <th class="p-3 border border-gray-700">Speed (m/s)</th>
                            <th class="p-3 border border-gray-700">% VO2max</th>
                            <th class="p-3 border border-gray-700">Session RPE (1-10) [6-20]</th>
                            <th class="p-3 border border-gray-700">Work Duration</th>
                        </tr>
                    </thead>
                    <tbody class="font-bold text-gray-900">
                        <!-- MODERATE -->
                        <tr>
                            <td rowspan="2"
                                class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                                MODERATE</td>
                            <td class="bg-lime-500 p-3 border-b border-gray-800/20">T1</td>
                            <td class="bg-lime-500 p-3 border-b border-gray-800/20 text-left pl-4">Light Aerobic</td>
                            <td id="zone_t1_hr" class="bg-lime-500 p-3 border-b border-gray-800/20">-</td>
                            <td id="zone_t1_speed" class="bg-lime-500 p-3 border-b border-gray-800/20">-</td>
                            <td class="bg-lime-500 p-3 border-b border-gray-800/20">50-60</td>
                            <td class="bg-lime-500 p-3 border-b border-gray-800/20">Very Light - Light (1-2) [7-11]</td>
                            <td class="bg-lime-500 p-3 border-b border-gray-800/20">1 - 6 h</td>
                        </tr>
                        <tr>
                            <td class="bg-lime-400 p-3">T2</td>
                            <td class="bg-lime-400 p-3 text-left pl-4">Moderate Aerobic</td>
                            <td id="zone_t2_hr" class="bg-lime-400 p-3">-</td>
                            <td id="zone_t2_speed" class="bg-lime-400 p-3">-</td>
                            <td class="bg-lime-400 p-3">60-75</td>
                            <td class="bg-lime-400 p-3">Light - Somewhat Hard (2-4) [11-13]</td>
                            <td class="bg-lime-400 p-3">1 - 3 h</td>
                        </tr>

                        <!-- 1st Metabolic Threshold -->
                        <tr>
                            <td colspan="8"
                                class="bg-gray-700 text-white p-2 text-center font-bold tracking-wider text-xs border-y border-gray-600">
                                1ST METABOLIC THRESHOLD MT1/LT1</td>
                        </tr>

                        <!-- HEAVY -->
                        <tr>
                            <td rowspan="2"
                                class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                                HEAVY</td>
                            <td class="bg-yellow-400 p-3 border-b border-gray-800/20">T3</td>
                            <td class="bg-yellow-400 p-3 border-b border-gray-800/20 text-left pl-4">Heavy Aerobic</td>
                            <td id="zone_t3_hr" class="bg-yellow-400 p-3 border-b border-gray-800/20">-</td>
                            <td id="zone_t3_speed" class="bg-yellow-400 p-3 border-b border-gray-800/20">-</td>
                            <td class="bg-yellow-400 p-3 border-b border-gray-800/20">70-85</td>
                            <td class="bg-yellow-400 p-3 border-b border-gray-800/20">Somewhat Hard - Hard (4-5) [13-15]
                            </td>
                            <td class="bg-yellow-400 p-3 border-b border-gray-800/20">45 - 90 min</td>
                        </tr>
                        <tr>
                            <td class="bg-orange-400 p-3">T4</td>
                            <td class="bg-orange-400 p-3 text-left pl-4">Threshold</td>
                            <td id="zone_t4_hr" class="bg-orange-400 p-3">-</td>
                            <td id="zone_t4_speed" class="bg-orange-400 p-3">-</td>
                            <td class="bg-orange-400 p-3">80-90</td>
                            <td class="bg-orange-400 p-3">Somewhat Hard - Very Hard (5-7) [15-17]</td>
                            <td class="bg-orange-400 p-3">30 - 60 min</td>
                        </tr>

                        <!-- 2nd Metabolic Threshold -->
                        <tr>
                            <td colspan="8"
                                class="bg-gray-700 text-white p-2 text-center font-bold tracking-wider text-xs border-y border-gray-600">
                                2ND METABOLIC THRESHOLD MT2/LT2</td>
                        </tr>

                        <!-- SEVERE -->
                        <tr>
                            <td
                                class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                                SEVERE*</td>
                            <td class="bg-orange-600 p-3 text-white">T5</td>
                            <td class="bg-orange-600 p-3 text-white text-left pl-4">Maximal Aerobic</td>
                            <td id="zone_t5_hr" class="bg-orange-600 p-3 text-white">-</td>
                            <td id="zone_t5_speed" class="bg-orange-600 p-3 text-white">-</td>
                            <td class="bg-orange-600 p-3 text-white">90-100</td>
                            <td class="bg-orange-600 p-3 text-white">Very Hard - Maximal (7-10) [17-20]</td>
                            <td class="bg-orange-600 p-3 text-white">12 - 30 min</td>
                        </tr>

                        <!-- EXTREME -->
                        <tr>
                            <td rowspan="3"
                                class="bg-white p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                                EXTREME*</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">T6</td>
                            <td class="bg-red-600 p-3 text-white text-left pl-4 border-b border-gray-800/20">Speed/Power
                                Tolerance</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">Maximal (10) [20]</td>
                            <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">4 - 12 min</td>
                        </tr>
                        <tr>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">T7</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20 text-left pl-4">Speed/Power
                                Production</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">N/A</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">Maximal (10) [20]</td>
                            <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">2 - 6 min</td>
                        </tr>
                        <tr>
                            <td class="bg-rose-950 p-3 text-white">T8</td>
                            <td class="bg-rose-950 p-3 text-white text-left pl-4">Neuro-muscular Power</td>
                            <td class="bg-rose-950 p-3 text-white">N/A</td>
                            <td class="bg-rose-950 p-3 text-white">N/A</td>
                            <td class="bg-rose-950 p-3 text-white">N/A</td>
                            <td class="bg-rose-950 p-3 text-white">Maximal (10) [20]</td>
                            <td class="bg-rose-950 p-3 text-white">10 s - 2 min</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Step Efficiency Table -->
        <div id="efficiencyResults" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-white">5. Step Efficiency</h2>
            <p class="text-sm text-gray-400 mb-4">Calculated as (velocityÂ³) / (stroke rate / 60).</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-2 font-semibold text-gray-300 w-1/12 text-center">Step</th>
                            <th class="p-2 font-semibold text-gray-300 w-2/12 text-center">Score</th>
                            <th class="p-2 font-semibold text-gray-300 w-2/12 text-center">% Change</th>
                            <th class="p-2 font-semibold text-gray-300 w-7/12 text-center">Comparison to Step 1</th>
                        </tr>
                    </thead>
                    <tbody id="efficiencyBody"></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Printable Report Template (Hidden) -->
    <div id="printableReport" class="hidden bg-white text-black p-8 font-sans">
        <style>
            #printableReport .page-break {
                page-break-before: always;
            }

            #printableReport h1 {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 10px;
                color: #111827;
            }

            #printableReport h2 {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #374151;
                border-bottom: 2px solid #e5e7eb;
                padding-bottom: 4px;
            }

            #printableReport h3 {
                font-size: 16px;
                font-weight: 600;
                color: #4b5563;
            }

            #printableReport p,
            #printableReport td,
            #printableReport th {
                font-size: 12px;
            }

            #printableReport table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 16px;
            }

            #printableReport th,
            #printableReport td {
                border: 1px solid #d1d5db;
                padding: 4px 8px;
                text-align: center;
            }

            #printableReport th {
                background-color: #f3f4f6;
                font-weight: 600;
            }

            #printableReport .chart-container {
                position: relative;
                height: 300px;
                width: 100%;
                margin-bottom: 16px;
            }

            #printableReport .section-box {
                border: 1px solid #e5e7eb;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 16px;
            }

            #printableReport .meta-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 16px;
            }

            #printableReport .meta-item {
                display: flex;
                flex-direction: column;
            }

            #printableReport .meta-label {
                font-size: 10px;
                color: #6b7280;
                font-weight: 600;
                text-transform: uppercase;
            }

            #printableReport .meta-value {
                font-size: 14px;
                font-weight: 500;
                color: #111827;
            }
        </style>

        <!-- Page 1: Details, Inputs, Charts -->
        <div class="page-1">
            <h1 class="text-center mb-6">Canoe Slalom Lactate Threshold Report</h1>

            <!-- Metadata -->
            <div class="section-box">
                <div class="meta-grid">
                    <div class="meta-item"><span class="meta-label">Athlete Name</span><span id="print_athleteName"
                            class="meta-value">-</span></div>
                    <div class="meta-item"><span class="meta-label">Date</span><span id="print_date"
                            class="meta-value">-</span></div>
                    <div class="meta-item"><span class="meta-label">Boat Class</span><span id="print_boatClass"
                            class="meta-value">-</span></div>
                    <div class="meta-item"><span class="meta-label">Protocol</span><span id="print_protocol"
                            class="meta-value">-</span></div>
                </div>
                <div class="meta-item w-full"><span class="meta-label">Comments</span><span id="print_comments"
                        class="meta-value">-</span></div>
            </div>

            <!-- Input Data -->
            <h2 class="section-title">Step Test Data</h2>
            <div id="print_inputTableContainer"></div>

            <!-- Charts (2x2 Grid) -->
            <h2 class="section-title mt-6">Performance Visualizations</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="chart-container"><canvas id="print_lactateChart"></canvas></div>
                <div class="chart-container"><canvas id="print_hrChart"></canvas></div>
                <div class="chart-container"><canvas id="print_srChart"></canvas></div>
                <div class="chart-container"><canvas id="print_efficiencyChart"></canvas></div>
            </div>
        </div>

        <!-- Page 2: Thresholds, Zones -->
        <div class="page-break">
            <h2 class="mb-6">Thresholds & Training Zones</h2>

            <!-- Calculated Thresholds -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="section-box bg-teal-50 border-teal-200">
                    <h3 class="text-teal-800 mb-2">Lactate Threshold 1 (LT1)</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="meta-label">HR</p>
                            <p id="print_lt1_hr" class="text-lg font-bold">-</p>
                        </div>
                        <div>
                            <p class="meta-label">Speed</p>
                            <p id="print_lt1_speed" class="text-lg font-bold">-</p>
                        </div>
                        <div>
                            <p class="meta-label">Lactate</p>
                            <p id="print_lt1_lactate" class="text-lg font-bold">-</p>
                        </div>
                    </div>
                </div>
                <div class="section-box bg-red-50 border-red-200">
                    <h3 class="text-red-800 mb-2">Lactate Threshold 2 (LT2)</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="meta-label">HR</p>
                            <p id="print_lt2_hr" class="text-lg font-bold">-</p>
                        </div>
                        <div>
                            <p class="meta-label">Speed</p>
                            <p id="print_lt2_speed" class="text-lg font-bold">-</p>
                        </div>
                        <div>
                            <p class="meta-label">Lactate</p>
                            <p id="print_lt2_lactate" class="text-lg font-bold">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Lactate Points -->
            <div class="section-box mb-6">
                <h3 class="mb-4">Key Lactate Points</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <h4 class="font-bold">2.0 mmol/L</h4>
                        <p id="print_2mmol" class="text-sm mt-1">-</p>
                    </div>
                    <div>
                        <h4 class="font-bold">4.0 mmol/L</h4>
                        <p id="print_4mmol" class="text-sm mt-1">-</p>
                    </div>
                    <div>
                        <h4 class="font-bold">6.0 mmol/L</h4>
                        <p id="print_6mmol" class="text-sm mt-1">-</p>
                    </div>
                </div>
            </div>

            <!-- Training Zones -->
            <h3 class="mb-2">Training Zones</h3>
            <div id="print_zonesTableContainer"></div>
        </div>

        <!-- Page 3: Efficiency -->
        <div class="page-break">
            <h2 class="mb-6">Step Efficiency Analysis</h2>
            <div id="print_efficiencyTableContainer"></div>
        </div>
    </div>

    <script>
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const dataBody = document.getElementById('dataBody');
        const addRowBtn = document.getElementById('addRowBtn');
        const removeRowBtn = document.getElementById('removeRowBtn');
        const efficiencyResultsDiv = document.getElementById('efficiencyResults');
        const tableHeaderRow = document.getElementById('tableHeaderRow');
        const tableTypeToggleContainer = document.getElementById('tableTypeToggle');

        let lactateChart = null;
        let efficiencyChart = null;
        let hrChart = null;
        let srChart = null;
        let currentTableType = 'hr';
        let lastCalculationData = null;

        const tableConfigs = {
            hr: {
                headers: ['Step', 'HR Planned (BPM)', 'HR Achieved (BPM)', 'Speed (m/s)', 'Lactate (mmol)', 'Stroke Rate (spm)'],
                classes: ['', '', 'hr', 'speed', 'lactate', 'sr']
            },
            speed: {
                headers: ['Step', 'Speed Planned (m/s)', 'Speed Achieved (m/s)', 'Heart Rate (BPM)', 'Lactate (mmol)', 'Stroke Rate (spm)'],
                classes: ['', '', 'speed', 'hr', 'lactate', 'sr']
            },
            sr: {
                headers: ['Step', 'SR Planned (spm)', 'SR Achieved (spm)', 'Speed (m/s)', 'Lactate (mmol)', 'Heart Rate (BPM)'],
                classes: ['', '', 'sr', 'speed', 'lactate', 'hr']
            }
        };

        function updateTableHeaders(type) {
            const config = tableConfigs[type];
            tableHeaderRow.innerHTML = config.headers.map(h => `<th class="p-2 font-semibold text-gray-300">${h}</th>`).join('');
        }

        function createRow(stepNumber) {
            const row = document.createElement('tr');
            const config = tableConfigs[currentTableType];
            let cells = `<td class="p-1"><input type="text" value="${stepNumber}" readonly class="bg-gray-100"></td>`;
            for (let i = 1; i < config.headers.length; i++) {
                cells += `<td class="p-1"><input type="number" step="any" class="${config.classes[i] || ''}" placeholder="${config.headers[i].split(' ')[0]}"></td>`;
            }
            row.innerHTML = cells;
            dataBody.appendChild(row);
        }

        function updateMaxRow() {
            const rowCount = dataBody.rows.length;
            if (rowCount === 0) return;
            for (let i = 0; i < rowCount; i++) {
                const row = dataBody.rows[i];
                const plannedInput = row.cells[1].querySelector('input');
                if (plannedInput.readOnly) {
                    plannedInput.value = '';
                    plannedInput.readOnly = false;
                    plannedInput.type = 'number';
                    plannedInput.classList.remove('bg-gray-100');
                }
            }
            const lastRow = dataBody.rows[rowCount - 1];
            const lastPlannedInput = lastRow.cells[1].querySelector('input');
            lastPlannedInput.type = 'text';
            lastPlannedInput.value = 'Max';
            lastPlannedInput.readOnly = true;
            lastPlannedInput.classList.add('bg-gray-100');
        }

        function populateTable(rowCount) {
            dataBody.innerHTML = '';
            for (let i = 1; i <= rowCount; i++) {
                createRow(i);
            }
            updateMaxRow();
        }

        tableTypeToggleContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                tableTypeToggleContainer.querySelector('.toggle-btn-active').classList.remove('toggle-btn-active');
                e.target.classList.add('toggle-btn-active');
                currentTableType = e.target.dataset.type;
                updateTableHeaders(currentTableType);
                populateTable(dataBody.rows.length || 7);
            }
        });



        addRowBtn.addEventListener('click', () => {
            createRow(dataBody.rows.length + 1);
            updateMaxRow();
        });
        removeRowBtn.addEventListener('click', () => {
            if (dataBody.rows.length > 1) {
                dataBody.removeChild(dataBody.lastChild);
                updateMaxRow();
            }
        });

        dataBody.addEventListener('keydown', (e) => {
            const target = e.target;
            if (target.tagName !== 'INPUT' || target.readOnly) return;
            const cell = target.parentElement;
            const row = cell.parentElement;
            const cellIndex = cell.cellIndex;
            const rowIndex = row.rowIndex - 1;
            let nextCell = null;
            switch (e.key) {
                case 'ArrowUp': if (rowIndex > 0) nextCell = dataBody.rows[rowIndex - 1].cells[cellIndex].querySelector('input'); break;
                case 'ArrowDown': case 'Enter': if (rowIndex < dataBody.rows.length - 1) nextCell = dataBody.rows[rowIndex + 1].cells[cellIndex].querySelector('input'); break;
                case 'ArrowLeft': if (cellIndex > 1) nextCell = row.cells[cellIndex - 1].querySelector('input'); break;
                case 'ArrowRight': if (cellIndex < row.cells.length - 1) nextCell = row.cells[cellIndex + 1].querySelector('input'); break;
            }
            if (nextCell && !nextCell.readOnly) { e.preventDefault(); nextCell.focus(); nextCell.select(); }
        });

        dataBody.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const rows = text.split(/\r?\n/).filter(row => row.length > 0);
            const startCell = e.target.parentElement;
            const startRow = startCell.parentElement;
            const startCellIndex = startCell.cellIndex;
            const startRowIndex = startRow.rowIndex - 1;
            rows.forEach((rowText, rowIndex) => {
                const cells = rowText.split('\t');
                const targetRowIndex = startRowIndex + rowIndex;
                if (targetRowIndex < dataBody.rows.length) {
                    cells.forEach((cellText, cellIndex) => {
                        const targetCellIndex = startCellIndex + cellIndex;
                        const targetRow = dataBody.rows[targetRowIndex];
                        if (targetCellIndex < targetRow.cells.length) {
                            const input = targetRow.cells[targetCellIndex].querySelector('input');
                            if (input && !input.readOnly) input.value = cellText;
                        }
                    });
                }
            });
        });

        calculateBtn.addEventListener('click', () => {
            try {
                const parsedData = [];
                let hasSrData = true;
                for (let row of dataBody.rows) {
                    const hr = parseFloat(row.querySelector('.hr')?.value);
                    const speed = parseFloat(row.querySelector('.speed')?.value);
                    const lactate = parseFloat(row.querySelector('.lactate')?.value);
                    if (!isNaN(hr) && !isNaN(speed) && !isNaN(lactate)) {
                        const srVal = parseFloat(row.querySelector('.sr')?.value);
                        if (isNaN(srVal) || srVal <= 0) { hasSrData = false; }
                        parsedData.push({ hr, speed, lactate, sr: srVal });
                    }
                }
                if (parsedData.length < 5) { throw new Error("Not enough valid data points. A minimum of 5 points are required for this analysis."); }
                parsedData.sort((a, b) => a.speed - b.speed);

                const speedLactateRegression = regression.polynomial(parsedData.map(d => [d.speed, d.lactate]), { order: 3 });
                const speedHrRegression = regression.polynomial(parsedData.map(d => [d.speed, d.hr]), { order: 3 });
                let speedSrRegression = null;
                if (hasSrData) { speedSrRegression = regression.polynomial(parsedData.map(d => [d.speed, d.sr]), { order: 3 }); }

                const minLactatePoint = parsedData.reduce((min, p) => p.lactate < min.lactate ? p : min, parsedData[0]);
                const lt1Lactate = minLactatePoint.lactate + 0.4;
                const searchStartSpeedForLt1 = minLactatePoint.speed;
                let lt1Speed = 0, minSpeedDiff = Infinity;
                const speedRange = parsedData[parsedData.length - 1].speed - parsedData[0].speed;
                for (let s = searchStartSpeedForLt1; s <= parsedData[parsedData.length - 1].speed; s += speedRange / 1000) {
                    const predictedLactate = speedLactateRegression.predict(s)[1];
                    const diff = Math.abs(predictedLactate - lt1Lactate);
                    if (diff < minSpeedDiff) { minSpeedDiff = diff; lt1Speed = s; }
                }
                const lt1Hr = speedHrRegression.predict(lt1Speed)[1];

                let modDmaxStartDataPoint = parsedData[0];
                for (let i = 1; i < parsedData.length; i++) {
                    if (parsedData[i].lactate - parsedData[i - 1].lactate > 0.4) { modDmaxStartDataPoint = parsedData[i - 1]; break; }
                }
                const endPointDataPoint = parsedData[parsedData.length - 1];
                const modStartPoint = { x: modDmaxStartDataPoint.speed, y: modDmaxStartDataPoint.lactate };
                const endPoint = { x: endPointDataPoint.speed, y: endPointDataPoint.lactate };
                let maxDistance = 0; let lt2Point = { speed: 0, lactate: 0 };
                for (let s = modStartPoint.x; s <= endPoint.x; s += speedRange / 1000) {
                    const curveLactate = speedLactateRegression.predict(s)[1];
                    const distance = perpendicularDistance({ x: s, y: curveLactate }, modStartPoint, endPoint);
                    if (distance > maxDistance) { maxDistance = distance; lt2Point = { speed: s, lactate: curveLactate }; }
                }
                const lt2Hr = speedHrRegression.predict(lt2Point.speed)[1];

                const fixedLactateTargets = [2, 4, 6];
                const fixedLactateResultsData = {};
                fixedLactateTargets.forEach(targetLactate => {
                    let bestSpeed = 0; let minDiff = Infinity;
                    for (let s = parsedData[0].speed; s <= parsedData[parsedData.length - 1].speed; s += speedRange / 1000) {
                        const predictedLactate = speedLactateRegression.predict(s)[1];
                        const diff = Math.abs(predictedLactate - targetLactate);
                        if (diff < minDiff) { minDiff = diff; bestSpeed = s; }
                    }
                    fixedLactateResultsData[targetLactate] = { hr: speedHrRegression.predict(bestSpeed)[1].toFixed(0), speed: bestSpeed.toFixed(2) };
                });

                let efficiencyData = null;
                if (hasSrData) {
                    efficiencyData = parsedData.map((d, i) => ({ step: i + 1, efficiency: (d.speed ** 3) / (d.sr / 60) }));
                    displayEfficiency(efficiencyData);
                    efficiencyResultsDiv.classList.remove('hidden');
                } else {
                    efficiencyResultsDiv.classList.add('hidden');
                }

                // Show Training Zones (always shown on calc)
                document.getElementById('trainingZones').classList.remove('hidden');

                // Add this line to show export btn
                document.getElementById('exportPdfBtn').classList.remove('hidden');

                lastCalculationData = { parsedData, efficiencyData, regressions: { lactate: speedLactateRegression, hr: speedHrRegression, sr: speedSrRegression }, thresholds: { lt1: { speed: lt1Speed, lactate: lt1Lactate }, lt2: lt2Point, modDmaxLine: { start: modStartPoint, end: endPoint } } };
                displayResults({ lt1: { hr: lt1Hr.toFixed(0), speed: lt1Speed.toFixed(2), lactate: lt1Lactate.toFixed(2) }, lt2: { hr: lt2Hr.toFixed(0), speed: lt2Point.speed.toFixed(2), lactate: lt2Point.lactate.toFixed(2) } });
                displayFixedLactatePoints(fixedLactateResultsData);

                // Calculate and display Training Zones
                const maxHr = parsedData[parsedData.length - 1].hr;
                const maxSpeed = parsedData[parsedData.length - 1].speed;
                displayTrainingZones({ maxHr, lt1Hr, lt2Hr, maxSpeed, lt1Speed, lt2Speed: lt2Point.speed });

                renderLactateChart();
                renderHrChart();
                renderSrChart();
                renderEfficiencyChart();

                errorDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                errorDiv.textContent = `Error: ${e.message}`;
                errorDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                efficiencyResultsDiv.classList.add('hidden');
                document.getElementById('trainingZones').classList.add('hidden');
                lastCalculationData = null;
            }
        });

        function perpendicularDistance(p, a, b) { const { x, y } = p, { x: x1, y: y1 } = a, { x: x2, y: y2 } = b; const A = y2 - y1, B = x1 - x2, C = -A * x1 - B * y1; return Math.abs(A * x + B * y + C) / Math.sqrt(A * A + B * B); }
        function displayResults(t) { document.getElementById('lt1_hr').textContent = t.lt1.hr; document.getElementById('lt1_speed').textContent = t.lt1.speed; document.getElementById('lt1_lactate').textContent = t.lt1.lactate; document.getElementById('lt2_hr').textContent = t.lt2.hr; document.getElementById('lt2_speed').textContent = t.lt2.speed; document.getElementById('lt2_lactate').textContent = t.lt2.lactate; }
        function displayFixedLactatePoints(r) { document.getElementById('hr_2mmol').textContent = r[2].hr; document.getElementById('speed_2mmol').textContent = r[2].speed; document.getElementById('hr_4mmol').textContent = r[4].hr; document.getElementById('speed_4mmol').textContent = r[4].speed; document.getElementById('hr_6mmol').textContent = r[6].hr; document.getElementById('speed_6mmol').textContent = r[6].speed; }

        function displayTrainingZones({ maxHr, lt1Hr, lt2Hr, maxSpeed, lt1Speed, lt2Speed }) {
            // Heart Rate Zones
            const r_max = Math.round(maxHr);
            const r_lt1 = Math.round(lt1Hr);
            const r_lt2 = Math.round(lt2Hr);
            const r_hr_midpoint = Math.round(lt1Hr + (lt2Hr - lt1Hr) / 2);

            document.getElementById('zone_t1_hr').textContent = `< ${Math.round(r_max * 0.7)}`;
            document.getElementById('zone_t2_hr').textContent = `${Math.round(r_max * 0.7)} - ${r_lt1}`;
            document.getElementById('zone_t3_hr').textContent = `${r_lt1} - ${r_hr_midpoint}`;
            document.getElementById('zone_t4_hr').textContent = `${r_hr_midpoint} - ${r_lt2}`;
            document.getElementById('zone_t5_hr').textContent = `> ${r_lt2}`;

            // Speed Zones
            const s_max = parseFloat(maxSpeed);
            const s_lt1 = parseFloat(lt1Speed);
            const s_lt2 = parseFloat(lt2Speed); // This is LT2 speed, not ModDMax line speed, assuming they are the same logic for zones
            const s_lt2_val = typeof lt2Speed === 'object' ? parseFloat(lt2Speed.speed) : parseFloat(lt2Speed); // Handle if it's an object or value

            // Ensure we are using the correct scalar values
            // lt1Speed was passed as number (or string from toFixed? No, lt1Speed variable is number)
            // lt2Speed was passed as lt2Point object in CalculateBtn? -> Wait, let's check
            // In calculateBtn: lt2Point = { speed: s, lactate: ... }
            // Argument passed: lt2Speed: lt2Point.speed (which is a number)

            const s_midpoint = s_lt1 + (s_lt2 - s_lt1) / 2;
            const s_75max = s_max * 0.75;

            // Zone 1: < 75% Max Speed
            document.getElementById('zone_t1_speed').textContent = `< ${s_75max.toFixed(2)}`;

            // Zone 2: 75% Max Speed - LT1
            document.getElementById('zone_t2_speed').textContent = `${s_75max.toFixed(2)} - ${s_lt1.toFixed(2)}`;

            // Zone 3: LT1 - Midpoint
            document.getElementById('zone_t3_speed').textContent = `${s_lt1.toFixed(2)} - ${s_midpoint.toFixed(2)}`;

            // Zone 4: Midpoint - LT2
            document.getElementById('zone_t4_speed').textContent = `${s_midpoint.toFixed(2)} - ${s_lt2.toFixed(2)}`;

            // Zone 5: > LT2
            document.getElementById('zone_t5_speed').textContent = `> ${s_lt2.toFixed(2)}`;
        }

        function displayEfficiency(efficiencyData) {
            const efficiencyBody = document.getElementById('efficiencyBody');
            efficiencyBody.innerHTML = '';
            if (!efficiencyData || efficiencyData.length < 1) return;

            const baselineEfficiency = efficiencyData[0].efficiency;

            const changes = efficiencyData.map((item, index) => {
                if (index === 0) return { ...item, percentChange: 0 };
                const percentChange = ((item.efficiency - baselineEfficiency) / baselineEfficiency) * 100;
                return { ...item, percentChange };
            });

            const maxAbsChange = Math.max(1, ...changes.map(c => Math.abs(c.percentChange)));

            const getPositiveGradientColor = (value, max) => {
                const percentage = max === 0 ? 1 : value / max;
                const hue = 160 + (percentage * 50); // From teal (160) to bright blue (210)
                return `hsl(${hue}, 70%, 50%)`;
            };

            const getNegativeGradientColor = (value, max) => {
                const percentage = max === 0 ? 1 : value / max;
                const hue = 60 - (percentage * 60); // From yellow (60) to red (0)
                return `hsl(${hue}, 70%, 50%)`;
            };

            changes.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 last:border-b-0';

                let barHtml;
                const barWidth = maxAbsChange > 0 ? (Math.abs(item.percentChange) / maxAbsChange) * 100 : 0;
                const displayChange = item.percentChange.toFixed(1);

                if (item.percentChange >= 0) {
                    const barColor = getPositiveGradientColor(item.percentChange, maxAbsChange);
                    barHtml = `
                        <div class="w-1/2 flex justify-end"></div>
                        <div class="w-px h-6 bg-gray-500"></div>
                        <div class="w-1/2 flex justify-start">
                             <div class="h-4 rounded-r-full" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                        </div>
                    `;
                } else {
                    const barColor = getNegativeGradientColor(Math.abs(item.percentChange), maxAbsChange);
                    barHtml = `
                        <div class="w-1/2 flex justify-end">
                             <div class="h-4 rounded-l-full" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                        </div>
                        <div class="w-px h-6 bg-gray-500"></div>
                        <div class="w-1/2 flex justify-start"></div>
                    `;
                }

                row.innerHTML = `
                    <td class="p-3 font-medium text-center">${item.step}</td>
                    <td class="p-3 font-mono text-center">${item.efficiency.toFixed(3)}</td>
                    <td class="p-3 font-mono text-center ${item.percentChange > 0 ? 'text-teal-400' : item.percentChange < 0 ? 'text-red-400' : ''}">
                        ${item.percentChange >= 0 ? '+' : ''}${displayChange}%
                    </td>
                    <td class="p-3">
                        <div class="flex items-center" title="Change from Step 1: ${displayChange}%">
                           ${barHtml}
                        </div>
                    </td>
                `;
                efficiencyBody.appendChild(row);
            });
        }

        function getChartOptions(yAxisLabel) {
            const tickColor = 'rgba(255, 255, 255, 0.3)';
            const labelColor = 'rgba(255, 255, 255, 0.7)';
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Speed (m/s)', font: { size: 14 }, color: labelColor }, ticks: { color: tickColor }, grid: { color: tickColor } },
                    y: { title: { display: true, text: yAxisLabel, font: { size: 14 }, color: labelColor }, ticks: { color: tickColor }, grid: { color: tickColor } }
                },
                plugins: {
                    legend: { labels: { color: labelColor, filter: (i, c) => !i.text.includes('Curve') && !i.text.includes('Line') } },
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: (${c.parsed.x.toFixed(2)}, ${c.parsed.y.toFixed(3)})` } }
                }
            };
        }

        function getChartOptionsLight(yAxisLabel) {
            const tickColor = '#374151'; // gray-700
            const labelColor = '#111827'; // gray-900
            const gridColor = '#e5e7eb'; // gray-200
            return {
                responsive: true, maintainAspectRatio: false,
                animation: false, // Disable animation for print
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Speed (m/s)', font: { size: 12 }, color: labelColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                    y: { title: { display: true, text: yAxisLabel, font: { size: 12 }, color: labelColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } }
                },
                plugins: {
                    legend: { labels: { color: labelColor, font: { size: 10 }, filter: (i, c) => !i.text.includes('Curve') && !i.text.includes('Line') } },
                }
            };
        }

        // --- PDF Export Logic ---
        document.getElementById('exportPdfBtn').addEventListener('click', async () => {
            const btn = document.getElementById('exportPdfBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Generating PDF...';
            btn.disabled = true;

            try {
                // 1. Populate Metadata
                document.getElementById('print_athleteName').textContent = document.getElementById('athleteName').value || '-';
                const d = document.getElementById('testDate').value;
                document.getElementById('print_date').textContent = d ? new Date(d).toLocaleDateString() : '-';
                document.getElementById('print_boatClass').textContent = document.getElementById('boatClass').value;
                document.getElementById('print_protocol').textContent = document.getElementById('protocol').value || '-';
                document.getElementById('print_comments').textContent = document.getElementById('comments').value || '-';

                // 2. Clone Tables
                // Input Table (Create a static version)
                const inputContainer = document.getElementById('print_inputTableContainer');
                let inputHtml = '<table class="w-full text-xs"><thead><tr class="bg-gray-100">';
                // Headers from current type
                const headers = tableConfigs[currentTableType].headers;
                headers.forEach(h => inputHtml += `<th>${h}</th>`);
                inputHtml += '</tr></thead><tbody>';

                // Rows
                // We need to read values from inputs
                for (let i = 0; i < dataBody.rows.length; i++) {
                    const row = dataBody.rows[i];
                    inputHtml += '<tr>';
                    inputHtml += `<td>${row.cells[0].querySelector('input').value}</td>`; // Step
                    // Loop other cells
                    for (let j = 1; j < row.cells.length; j++) {
                        const val = row.cells[j].querySelector('input').value;
                        inputHtml += `<td>${val}</td>`;
                    }
                    inputHtml += '</tr>';
                }
                inputHtml += '</tbody></table>';
                inputContainer.innerHTML = inputHtml;

                // Thresholds
                const t = lastCalculationData; // Assume this is fresh
                if (!t) throw new Error("No data calculated");
                document.getElementById('print_lt1_hr').textContent = document.getElementById('lt1_hr').textContent;
                document.getElementById('print_lt1_speed').textContent = document.getElementById('lt1_speed').textContent;
                document.getElementById('print_lt1_lactate').textContent = document.getElementById('lt1_lactate').textContent;
                document.getElementById('print_lt2_hr').textContent = document.getElementById('lt2_hr').textContent;
                document.getElementById('print_lt2_speed').textContent = document.getElementById('lt2_speed').textContent;
                document.getElementById('print_lt2_lactate').textContent = document.getElementById('lt2_lactate').textContent;

                // Key Points
                document.getElementById('print_2mmol').textContent = `HR: ${document.getElementById('hr_2mmol').textContent}, Speed: ${document.getElementById('speed_2mmol').textContent}`;
                document.getElementById('print_4mmol').textContent = `HR: ${document.getElementById('hr_4mmol').textContent}, Speed: ${document.getElementById('speed_4mmol').textContent}`;
                document.getElementById('print_6mmol').textContent = `HR: ${document.getElementById('hr_6mmol').textContent}, Speed: ${document.getElementById('speed_6mmol').textContent}`;

                // Training Zones Table (Clone and style)
                const zonesTable = document.querySelector('#trainingZones table').cloneNode(true);
                // Strip input/dark classes? No, they are standard tables. Just ensure text is black.
                zonesTable.classList.remove('text-center', 'text-sm');
                zonesTable.classList.add('text-xs');
                // Remove white text classes from cells and replace with black if needed, or let parent CSS handle it?
                // The current table has explicit 'text-white' utility classes on some cells (Extrteme/Severe). 
                // We need to override or remove them. 
                zonesTable.querySelectorAll('.text-white').forEach(el => {
                    el.classList.remove('text-white');
                    el.classList.add('text-black'); // Force black for print
                });
                zonesTable.querySelectorAll('thead').forEach(el => {
                    el.classList.remove('bg-gray-900', 'text-white');
                    el.classList.add('bg-gray-200', 'text-black');
                });
                document.getElementById('print_zonesTableContainer').innerHTML = ''; // Clear prev
                document.getElementById('print_zonesTableContainer').appendChild(zonesTable);


                // Efficiency Table
                const effTable = document.querySelector('#efficiencyResults table').cloneNode(true);
                effTable.classList.remove('min-w-full');
                effTable.classList.add('w-full');
                effTable.querySelector('thead').classList.remove('bg-gray-700');
                effTable.querySelector('thead').classList.add('bg-gray-200');
                effTable.querySelectorAll('th').forEach(th => th.classList.remove('text-gray-300'));
                // Visual bars might be tricky. They are divs. They should print okay if background colors are preserved.
                document.getElementById('print_efficiencyTableContainer').innerHTML = '';
                document.getElementById('print_efficiencyTableContainer').appendChild(effTable);


                // 3. Render Charts (Light Mode)
                await renderPrintCharts();

                // 4. Generate PDF
                const element = document.getElementById('printableReport');
                element.classList.remove('hidden'); // Show briefly (sometimes needed for render) OR pass element directly works usually even if hidden? 
                // html2pdf usually needs it visible in DOM or at least rendered.
                // Better approach: Clone it off-screen or allow it to be visible but absolutely positioned off-screen?
                // Let's try visible but z-index behind? Or just block overlay.
                // For now, let's just make it visible, generate, hide.

                const opt = {
                    margin: 10,
                    filename: `Report_${document.getElementById('athleteName').value || 'Athlete'}_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(element).save();

                element.classList.add('hidden');

            } catch (e) {
                console.error(e);
                alert("Error generating PDF: " + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        async function renderPrintCharts() {
            if (!lastCalculationData) return;
            const { parsedData, regressions, thresholds, efficiencyData } = lastCalculationData;
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            // 1. Lactate
            new Chart(document.getElementById('print_lactateChart').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Data', data: parsedData.map(d => ({ x: d.speed, y: d.lactate })), backgroundColor: 'black', pointRadius: 4 },
                        { label: 'Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.lactate.predict(s)[1] })), type: 'line', borderColor: 'blue', borderWidth: 2, pointRadius: 0 },
                        { label: 'LT1', data: [{ x: thresholds.lt1.speed, y: thresholds.lt1.lactate }], backgroundColor: 'teal', pointRadius: 6 },
                        { label: 'LT2', data: [{ x: thresholds.lt2.speed, y: thresholds.lt2.lactate }], backgroundColor: 'red', pointRadius: 6 }
                    ]
                },
                options: getChartOptionsLight('Blood Lactate (mmol/L)')
            });

            // 2. HR
            new Chart(document.getElementById('print_hrChart').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Data', data: parsedData.map(d => ({ x: d.speed, y: d.hr })), backgroundColor: 'black', pointRadius: 4 },
                        { label: 'Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.hr.predict(s)[1] })), type: 'line', borderColor: 'red', borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: getChartOptionsLight('Heart Rate (BPM)')
            });

            // 3. SR
            let srDatasets = [];
            if (regressions.sr) {
                srDatasets = [
                    { label: 'Data', data: parsedData.map(d => ({ x: d.speed, y: d.sr })), backgroundColor: 'black', pointRadius: 4 },
                    { label: 'Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.sr.predict(s)[1] })), type: 'line', borderColor: 'green', borderWidth: 2, pointRadius: 0 }
                ];
            }
            new Chart(document.getElementById('print_srChart').getContext('2d'), {
                type: 'scatter', data: { datasets: srDatasets }, options: getChartOptionsLight('Stroke Rate (spm)')
            });

            // 4. Efficiency
            if (efficiencyData) {
                new Chart(document.getElementById('print_efficiencyChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: parsedData.map(d => d.speed.toFixed(2)),
                        datasets: [{ label: 'Efficiency', data: efficiencyData.map(d => d.efficiency), backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'blue', borderWidth: 1 }]
                    },
                    options: { ...getChartOptionsLight('Efficiency Score'), scales: { x: { ...getChartOptionsLight().scales.x, type: 'category' } } }
                });
            } else {
                // Render empty or placeholder if no data?
                // Or just leave blank canvas
            }

            // Wait a moment for charts to render
            await new Promise(r => setTimeout(r, 500));
        }

        function renderLactateChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions, thresholds } = lastCalculationData;
            const ctx = document.getElementById('lactateChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Blood Lactate (mmol/L)');
            const datasets = [
                { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.lactate })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6, order: 0 },
                { label: '3rd Order Polynomial Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.lactate.predict(s)[1] })), type: 'line', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2, pointRadius: 0, order: 1 },
                { label: 'Line (for ModDMax)', data: [thresholds.modDmaxLine.start, thresholds.modDmaxLine.end], type: 'line', borderColor: 'rgba(192, 132, 252, 0.6)', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, order: 2 },
                { label: 'LT1', data: [{ x: thresholds.lt1.speed, y: thresholds.lt1.lactate }], backgroundColor: 'rgba(45, 212, 191, 1)', borderColor: 'white', borderWidth: 2, pointRadius: 8, order: 3 },
                { label: 'LT2 (ModDMax)', data: [{ x: thresholds.lt2.speed, y: thresholds.lt2.lactate }], backgroundColor: 'rgba(248, 113, 113, 1)', borderColor: 'white', borderWidth: 2, pointRadius: 8, order: 4 }
            ];

            if (lactateChart) { lactateChart.destroy(); }
            lactateChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderHrChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions } = lastCalculationData;
            const ctx = document.getElementById('hrChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Heart Rate (BPM)');
            const datasets = [
                { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.hr })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6 },
                { label: 'HR Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.hr.predict(s)[1] })), type: 'line', borderColor: 'rgba(248, 113, 113, 1)', borderWidth: 2, pointRadius: 0 }
            ];

            if (hrChart) { hrChart.destroy(); }
            hrChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderSrChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions } = lastCalculationData;
            const ctx = document.getElementById('srChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Stroke Rate (spm)');
            let datasets = [];
            if (regressions.sr) {
                datasets = [
                    { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.sr })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6 },
                    { label: 'SR Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.sr.predict(s)[1] })), type: 'line', borderColor: 'rgba(45, 212, 191, 1)', borderWidth: 2, pointRadius: 0 }
                ];
            }

            if (srChart) { srChart.destroy(); }
            srChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderEfficiencyChart() {
            if (!lastCalculationData || !lastCalculationData.efficiencyData) {
                if (efficiencyChart) efficiencyChart.destroy();
                efficiencyChart = null;
                return;
            }
            const { parsedData, efficiencyData } = lastCalculationData;
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            const options = getChartOptions('Efficiency Score');
            const datasets = [{
                label: 'Efficiency',
                data: efficiencyData.map((d, i) => ({ x: parsedData[i].speed, y: d.efficiency })),
                borderColor: 'rgba(251, 191, 36, 1)',
                backgroundColor: 'transparent',
                type: 'line',
                pointRadius: 6,
                pointBackgroundColor: 'rgba(251, 191, 36, 0.7)'
            }];
            if (efficiencyChart) { efficiencyChart.destroy(); }
            efficiencyChart = new Chart(ctx, { type: 'line', data: { datasets }, options });
        }

        // Initial setup
        updateTableHeaders(currentTableType);
        populateTable(7);
    </script>
</body>

</html>