<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canoe Slalom Lactate Threshold Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Regression.js for polynomial curve fitting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style for table inputs in dark mode */
        #dataTable input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            /* gray-600 */
            border-radius: 0.375rem;
            text-align: center;
            background-color: #374151;
            /* gray-700 */
            color: #f3f4f6;
            /* gray-100 */
        }

        #dataTable input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: -1px;
            border-color: #3b82f6;
        }

        #dataTable input.bg-gray-100 {
            background-color: #4b5563 !important;
            /* gray-600 */
        }

        .toggle-btn {
            transition: all 0.2s ease-in-out;
        }

        .toggle-btn-active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Canoe Slalom Lactate Threshold Calculator</h1>
            <p class="mt-2 text-lg text-gray-400">Analyze step test data to determine LT1 and LT2 thresholds.</p>
        </header>

        <!-- Input Data Section -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-2 text-white">1. Input Data</h2>

            <div class="mb-4">
                <label class="font-semibold text-gray-300">Protocol Type:</label>
                <div id="tableTypeToggle" class="mt-2 flex bg-gray-700 rounded-lg p-1 max-w-md">
                    <button data-type="hr" class="toggle-btn toggle-btn-active flex-1 py-1 px-2 text-sm rounded-md">HR
                        Based</button>
                    <button data-type="speed" class="toggle-btn flex-1 py-1 px-2 text-sm rounded-md">Speed
                        Based</button>
                    <button data-type="sr" class="toggle-btn flex-1 py-1 px-2 text-sm rounded-md">Stroke Rate
                        Based</button>
                </div>
            </div>

            <p class="text-sm text-gray-400 mb-4">You can navigate the table with arrow keys and paste data from a
                spreadsheet.</p>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full text-sm">
                    <thead class="bg-gray-700">
                        <tr id="tableHeaderRow">
                            <!-- Headers will be dynamically inserted here -->
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- Rows will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
            <div class="flex space-x-2 mt-4">
                <button id="addRowBtn"
                    class="bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-all duration-300 text-xs">Add
                    Row</button>
                <button id="removeRowBtn"
                    class="bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-all duration-300 text-xs">Remove
                    Last Row</button>
            </div>

            <button id="calculateBtn"
                class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Calculate Thresholds & Efficiency
            </button>
            <div id="error" class="mt-4 text-red-400 font-medium hidden"></div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 1. Speed vs Lactate -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Lactate</h2>
                <div class="relative h-[350px]">
                    <canvas id="lactateChart"></canvas>
                </div>
            </div>
            <!-- 2. Speed vs HR -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Heart Rate</h2>
                <div class="relative h-[350px]">
                    <canvas id="hrChart"></canvas>
                </div>
            </div>
            <!-- 3. Speed vs Stroke Rate -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Speed vs Stroke Rate</h2>
                <div class="relative h-[350px]">
                    <canvas id="srChart"></canvas>
                </div>
            </div>
            <!-- 4. Step Efficiency Chart -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white">Step Efficiency Chart</h2>
                <div class="relative h-[350px]">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Calculated Thresholds -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-white">2. Calculated Thresholds</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h3 class="font-bold text-lg text-teal-400">Lactate Threshold 1 (LT1)</h3>
                            <p class="text-sm text-gray-400 mb-2">Calculated using the Lowest Lactate + 0.4 mmol/L
                                method.</p>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                    <p id="lt1_hr" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                    <p id="lt1_speed" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Lactate (mmol/L)</p>
                                    <p id="lt1_lactate" class="text-xl font-semibold">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h3 class="font-bold text-lg text-red-400">Lactate Threshold 2 (LT2)</h3>
                            <p class="text-sm text-gray-400 mb-2">Calculated using the Modified DMax method (Bishop et
                                al., 1998).</p>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                    <p id="lt2_hr" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                    <p id="lt2_speed" class="text-xl font-semibold">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Lactate (mmol/L)</p>
                                    <p id="lt2_lactate" class="text-xl font-semibold">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Key Lactate Points -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-white">3. Key Lactate Points</h2>
                    <p class="text-sm text-gray-400 mb-4">Speed and Heart Rate values interpolated from the curve at
                        fixed lactate levels.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">2.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_2mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_2mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">4.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_4mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_4mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 border border-gray-700 rounded-xl">
                            <h4 class="font-bold text-lg text-gray-300">6.0 mmol/L</h4>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Heart Rate</p>
                                <p id="hr_6mmol" class="text-xl font-semibold">-</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-400">Speed (m/s)</p>
                                <p id="speed_6mmol" class="text-xl font-semibold">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Training Zones Table -->
    <div id="trainingZones" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">4. Training Zones</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-center border-separate border-spacing-0 rounded-lg overflow-hidden">
                <thead class="bg-gray-900 text-white">
                    <tr>
                        <th class="p-3 border border-gray-700 w-32">Domain</th> <!-- Intensity/Domain -->
                        <th class="p-3 border border-gray-700">Zone</th>
                        <th class="p-3 border border-gray-700">Descriptor</th>
                        <th class="p-3 border border-gray-700">Heart Rate (BPM)</th>
                        <th class="p-3 border border-gray-700">% VO2max</th>
                        <th class="p-3 border border-gray-700">Session RPE (1-10) [6-20]</th>
                        <th class="p-3 border border-gray-700">Work Duration</th>
                    </tr>
                </thead>
                <tbody class="font-bold text-gray-900">
                    <!-- MODERATE -->
                    <tr>
                        <td rowspan="2"
                            class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                            MODERATE</td>
                        <td class="bg-lime-500 p-3 border-b border-gray-800/20">T1</td>
                        <td class="bg-lime-500 p-3 border-b border-gray-800/20 text-left pl-4">Light Aerobic</td>
                        <td id="zone_t1_hr" class="bg-lime-500 p-3 border-b border-gray-800/20">-</td>
                        <td class="bg-lime-500 p-3 border-b border-gray-800/20">50-60</td>
                        <td class="bg-lime-500 p-3 border-b border-gray-800/20">Very Light - Light (1-2) [7-11]</td>
                        <td class="bg-lime-500 p-3 border-b border-gray-800/20">1 - 6 h</td>
                    </tr>
                    <tr>
                        <td class="bg-lime-400 p-3">T2</td>
                        <td class="bg-lime-400 p-3 text-left pl-4">Moderate Aerobic</td>
                        <td id="zone_t2_hr" class="bg-lime-400 p-3">-</td>
                        <td class="bg-lime-400 p-3">60-75</td>
                        <td class="bg-lime-400 p-3">Light - Somewhat Hard (2-4) [11-13]</td>
                        <td class="bg-lime-400 p-3">1 - 3 h</td>
                    </tr>

                    <!-- 1st Metabolic Threshold -->
                    <tr>
                        <td colspan="7"
                            class="bg-gray-700 text-white p-2 text-center font-bold tracking-wider text-xs border-y border-gray-600">
                            1ST METABOLIC THRESHOLD MT1/LT1</td>
                    </tr>

                    <!-- HEAVY -->
                    <tr>
                        <td rowspan="2"
                            class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                            HEAVY</td>
                        <td class="bg-yellow-400 p-3 border-b border-gray-800/20">T3</td>
                        <td class="bg-yellow-400 p-3 border-b border-gray-800/20 text-left pl-4">Heavy Aerobic</td>
                        <td id="zone_t3_hr" class="bg-yellow-400 p-3 border-b border-gray-800/20">-</td>
                        <td class="bg-yellow-400 p-3 border-b border-gray-800/20">70-85</td>
                        <td class="bg-yellow-400 p-3 border-b border-gray-800/20">Somewhat Hard - Hard (4-5) [13-15]
                        </td>
                        <td class="bg-yellow-400 p-3 border-b border-gray-800/20">45 - 90 min</td>
                    </tr>
                    <tr>
                        <td class="bg-orange-400 p-3">T4</td>
                        <td class="bg-orange-400 p-3 text-left pl-4">Threshold</td>
                        <td id="zone_t4_hr" class="bg-orange-400 p-3">-</td>
                        <td class="bg-orange-400 p-3">80-90</td>
                        <td class="bg-orange-400 p-3">Somewhat Hard - Very Hard (5-7) [15-17]</td>
                        <td class="bg-orange-400 p-3">30 - 60 min</td>
                    </tr>

                    <!-- 2nd Metabolic Threshold -->
                    <tr>
                        <td colspan="7"
                            class="bg-gray-700 text-white p-2 text-center font-bold tracking-wider text-xs border-y border-gray-600">
                            2ND METABOLIC THRESHOLD MT2/LT2</td>
                    </tr>

                    <!-- SEVERE -->
                    <tr>
                        <td
                            class="bg-white border-b border-gray-300 p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                            SEVERE*</td>
                        <td class="bg-orange-600 p-3 text-white">T5</td>
                        <td class="bg-orange-600 p-3 text-white text-left pl-4">Maximal Aerobic</td>
                        <td id="zone_t5_hr" class="bg-orange-600 p-3 text-white">-</td>
                        <td class="bg-orange-600 p-3 text-white">90-100</td>
                        <td class="bg-orange-600 p-3 text-white">Very Hard - Maximal (7-10) [17-20]</td>
                        <td class="bg-orange-600 p-3 text-white">12 - 30 min</td>
                    </tr>

                    <!-- EXTREME -->
                    <tr>
                        <td rowspan="3"
                            class="bg-white p-2 align-middle font-black text-gray-900 tracking-wider text-center">
                            EXTREME*</td>
                        <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">T6</td>
                        <td class="bg-red-600 p-3 text-white text-left pl-4 border-b border-gray-800/20">Speed/Power
                            Tolerance</td>
                        <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">N/A</td>
                        <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">N/A</td>
                        <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">Maximal (10) [20]</td>
                        <td class="bg-red-600 p-3 text-white border-b border-gray-800/20">4 - 12 min</td>
                    </tr>
                    <tr>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">T7</td>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20 text-left pl-4">Speed/Power
                            Production</td>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">N/A</td>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">N/A</td>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">Maximal (10) [20]</td>
                        <td class="bg-red-800 p-3 text-white border-b border-gray-800/20">2 - 6 min</td>
                    </tr>
                    <tr>
                        <td class="bg-rose-950 p-3 text-white">T8</td>
                        <td class="bg-rose-950 p-3 text-white text-left pl-4">Neuro-muscular Power</td>
                        <td class="bg-rose-950 p-3 text-white">N/A</td>
                        <td class="bg-rose-950 p-3 text-white">N/A</td>
                        <td class="bg-rose-950 p-3 text-white">Maximal (10) [20]</td>
                        <td class="bg-rose-950 p-3 text-white">10 s - 2 min</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Step Efficiency Table -->
    <div id="efficiencyResults" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-white">5. Step Efficiency</h2>
        <p class="text-sm text-gray-400 mb-4">Calculated as (velocityÂ³) / (stroke rate / 60).</p>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="p-2 font-semibold text-gray-300 w-1/12 text-center">Step</th>
                        <th class="p-2 font-semibold text-gray-300 w-2/12 text-center">Score</th>
                        <th class="p-2 font-semibold text-gray-300 w-2/12 text-center">% Change</th>
                        <th class="p-2 font-semibold text-gray-300 w-7/12 text-center">Comparison to Step 1</th>
                    </tr>
                </thead>
                <tbody id="efficiencyBody"></tbody>
            </table>
        </div>
    </div>
    </div>
    </div>

    <script>
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const dataBody = document.getElementById('dataBody');
        const addRowBtn = document.getElementById('addRowBtn');
        const removeRowBtn = document.getElementById('removeRowBtn');
        const efficiencyResultsDiv = document.getElementById('efficiencyResults');
        const tableHeaderRow = document.getElementById('tableHeaderRow');
        const tableTypeToggleContainer = document.getElementById('tableTypeToggle');

        let lactateChart = null;
        let efficiencyChart = null;
        let hrChart = null;
        let srChart = null;
        let currentTableType = 'hr';
        let lastCalculationData = null;

        const tableConfigs = {
            hr: {
                headers: ['Step', 'HR Planned (BPM)', 'HR Achieved (BPM)', 'Speed (m/s)', 'Lactate (mmol)', 'Stroke Rate (spm)'],
                classes: ['', '', 'hr', 'speed', 'lactate', 'sr']
            },
            speed: {
                headers: ['Step', 'Speed Planned (m/s)', 'Speed Achieved (m/s)', 'Heart Rate (BPM)', 'Lactate (mmol)', 'Stroke Rate (spm)'],
                classes: ['', '', 'speed', 'hr', 'lactate', 'sr']
            },
            sr: {
                headers: ['Step', 'SR Planned (spm)', 'SR Achieved (spm)', 'Speed (m/s)', 'Lactate (mmol)', 'Heart Rate (BPM)'],
                classes: ['', '', 'sr', 'speed', 'lactate', 'hr']
            }
        };

        function updateTableHeaders(type) {
            const config = tableConfigs[type];
            tableHeaderRow.innerHTML = config.headers.map(h => `<th class="p-2 font-semibold text-gray-300">${h}</th>`).join('');
        }

        function createRow(stepNumber) {
            const row = document.createElement('tr');
            const config = tableConfigs[currentTableType];
            let cells = `<td class="p-1"><input type="text" value="${stepNumber}" readonly class="bg-gray-100"></td>`;
            for (let i = 1; i < config.headers.length; i++) {
                cells += `<td class="p-1"><input type="number" step="any" class="${config.classes[i] || ''}" placeholder="${config.headers[i].split(' ')[0]}"></td>`;
            }
            row.innerHTML = cells;
            dataBody.appendChild(row);
        }

        function updateMaxRow() {
            const rowCount = dataBody.rows.length;
            if (rowCount === 0) return;
            for (let i = 0; i < rowCount; i++) {
                const row = dataBody.rows[i];
                const plannedInput = row.cells[1].querySelector('input');
                if (plannedInput.readOnly) {
                    plannedInput.value = '';
                    plannedInput.readOnly = false;
                    plannedInput.type = 'number';
                    plannedInput.classList.remove('bg-gray-100');
                }
            }
            const lastRow = dataBody.rows[rowCount - 1];
            const lastPlannedInput = lastRow.cells[1].querySelector('input');
            lastPlannedInput.type = 'text';
            lastPlannedInput.value = 'Max';
            lastPlannedInput.readOnly = true;
            lastPlannedInput.classList.add('bg-gray-100');
        }

        function populateTable(rowCount) {
            dataBody.innerHTML = '';
            for (let i = 1; i <= rowCount; i++) {
                createRow(i);
            }
            updateMaxRow();
        }

        tableTypeToggleContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                tableTypeToggleContainer.querySelector('.toggle-btn-active').classList.remove('toggle-btn-active');
                e.target.classList.add('toggle-btn-active');
                currentTableType = e.target.dataset.type;
                updateTableHeaders(currentTableType);
                populateTable(dataBody.rows.length || 7);
            }
        });



        addRowBtn.addEventListener('click', () => {
            createRow(dataBody.rows.length + 1);
            updateMaxRow();
        });
        removeRowBtn.addEventListener('click', () => {
            if (dataBody.rows.length > 1) {
                dataBody.removeChild(dataBody.lastChild);
                updateMaxRow();
            }
        });

        dataBody.addEventListener('keydown', (e) => {
            const target = e.target;
            if (target.tagName !== 'INPUT' || target.readOnly) return;
            const cell = target.parentElement;
            const row = cell.parentElement;
            const cellIndex = cell.cellIndex;
            const rowIndex = row.rowIndex - 1;
            let nextCell = null;
            switch (e.key) {
                case 'ArrowUp': if (rowIndex > 0) nextCell = dataBody.rows[rowIndex - 1].cells[cellIndex].querySelector('input'); break;
                case 'ArrowDown': case 'Enter': if (rowIndex < dataBody.rows.length - 1) nextCell = dataBody.rows[rowIndex + 1].cells[cellIndex].querySelector('input'); break;
                case 'ArrowLeft': if (cellIndex > 1) nextCell = row.cells[cellIndex - 1].querySelector('input'); break;
                case 'ArrowRight': if (cellIndex < row.cells.length - 1) nextCell = row.cells[cellIndex + 1].querySelector('input'); break;
            }
            if (nextCell && !nextCell.readOnly) { e.preventDefault(); nextCell.focus(); nextCell.select(); }
        });

        dataBody.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const rows = text.split(/\r?\n/).filter(row => row.length > 0);
            const startCell = e.target.parentElement;
            const startRow = startCell.parentElement;
            const startCellIndex = startCell.cellIndex;
            const startRowIndex = startRow.rowIndex - 1;
            rows.forEach((rowText, rowIndex) => {
                const cells = rowText.split('\t');
                const targetRowIndex = startRowIndex + rowIndex;
                if (targetRowIndex < dataBody.rows.length) {
                    cells.forEach((cellText, cellIndex) => {
                        const targetCellIndex = startCellIndex + cellIndex;
                        const targetRow = dataBody.rows[targetRowIndex];
                        if (targetCellIndex < targetRow.cells.length) {
                            const input = targetRow.cells[targetCellIndex].querySelector('input');
                            if (input && !input.readOnly) input.value = cellText;
                        }
                    });
                }
            });
        });

        calculateBtn.addEventListener('click', () => {
            try {
                const parsedData = [];
                let hasSrData = true;
                for (let row of dataBody.rows) {
                    const hr = parseFloat(row.querySelector('.hr')?.value);
                    const speed = parseFloat(row.querySelector('.speed')?.value);
                    const lactate = parseFloat(row.querySelector('.lactate')?.value);
                    if (!isNaN(hr) && !isNaN(speed) && !isNaN(lactate)) {
                        const srVal = parseFloat(row.querySelector('.sr')?.value);
                        if (isNaN(srVal) || srVal <= 0) { hasSrData = false; }
                        parsedData.push({ hr, speed, lactate, sr: srVal });
                    }
                }
                if (parsedData.length < 5) { throw new Error("Not enough valid data points. A minimum of 5 points are required for this analysis."); }
                parsedData.sort((a, b) => a.speed - b.speed);

                const speedLactateRegression = regression.polynomial(parsedData.map(d => [d.speed, d.lactate]), { order: 3 });
                const speedHrRegression = regression.polynomial(parsedData.map(d => [d.speed, d.hr]), { order: 3 });
                let speedSrRegression = null;
                if (hasSrData) { speedSrRegression = regression.polynomial(parsedData.map(d => [d.speed, d.sr]), { order: 3 }); }

                const minLactatePoint = parsedData.reduce((min, p) => p.lactate < min.lactate ? p : min, parsedData[0]);
                const lt1Lactate = minLactatePoint.lactate + 0.4;
                const searchStartSpeedForLt1 = minLactatePoint.speed;
                let lt1Speed = 0, minSpeedDiff = Infinity;
                const speedRange = parsedData[parsedData.length - 1].speed - parsedData[0].speed;
                for (let s = searchStartSpeedForLt1; s <= parsedData[parsedData.length - 1].speed; s += speedRange / 1000) {
                    const predictedLactate = speedLactateRegression.predict(s)[1];
                    const diff = Math.abs(predictedLactate - lt1Lactate);
                    if (diff < minSpeedDiff) { minSpeedDiff = diff; lt1Speed = s; }
                }
                const lt1Hr = speedHrRegression.predict(lt1Speed)[1];

                let modDmaxStartDataPoint = parsedData[0];
                for (let i = 1; i < parsedData.length; i++) {
                    if (parsedData[i].lactate - parsedData[i - 1].lactate > 0.4) { modDmaxStartDataPoint = parsedData[i - 1]; break; }
                }
                const endPointDataPoint = parsedData[parsedData.length - 1];
                const modStartPoint = { x: modDmaxStartDataPoint.speed, y: modDmaxStartDataPoint.lactate };
                const endPoint = { x: endPointDataPoint.speed, y: endPointDataPoint.lactate };
                let maxDistance = 0; let lt2Point = { speed: 0, lactate: 0 };
                for (let s = modStartPoint.x; s <= endPoint.x; s += speedRange / 1000) {
                    const curveLactate = speedLactateRegression.predict(s)[1];
                    const distance = perpendicularDistance({ x: s, y: curveLactate }, modStartPoint, endPoint);
                    if (distance > maxDistance) { maxDistance = distance; lt2Point = { speed: s, lactate: curveLactate }; }
                }
                const lt2Hr = speedHrRegression.predict(lt2Point.speed)[1];

                const fixedLactateTargets = [2, 4, 6];
                const fixedLactateResultsData = {};
                fixedLactateTargets.forEach(targetLactate => {
                    let bestSpeed = 0; let minDiff = Infinity;
                    for (let s = parsedData[0].speed; s <= parsedData[parsedData.length - 1].speed; s += speedRange / 1000) {
                        const predictedLactate = speedLactateRegression.predict(s)[1];
                        const diff = Math.abs(predictedLactate - targetLactate);
                        if (diff < minDiff) { minDiff = diff; bestSpeed = s; }
                    }
                    fixedLactateResultsData[targetLactate] = { hr: speedHrRegression.predict(bestSpeed)[1].toFixed(0), speed: bestSpeed.toFixed(2) };
                });

                let efficiencyData = null;
                if (hasSrData) {
                    efficiencyData = parsedData.map((d, i) => ({ step: i + 1, efficiency: (d.speed ** 3) / (d.sr / 60) }));
                    displayEfficiency(efficiencyData);
                    efficiencyResultsDiv.classList.remove('hidden');
                } else {
                    efficiencyResultsDiv.classList.add('hidden');
                }

                // Show Training Zones (always shown on calc)
                document.getElementById('trainingZones').classList.remove('hidden');

                lastCalculationData = { parsedData, efficiencyData, regressions: { lactate: speedLactateRegression, hr: speedHrRegression, sr: speedSrRegression }, thresholds: { lt1: { speed: lt1Speed, lactate: lt1Lactate }, lt2: lt2Point, modDmaxLine: { start: modStartPoint, end: endPoint } } };
                displayResults({ lt1: { hr: lt1Hr.toFixed(0), speed: lt1Speed.toFixed(2), lactate: lt1Lactate.toFixed(2) }, lt2: { hr: lt2Hr.toFixed(0), speed: lt2Point.speed.toFixed(2), lactate: lt2Point.lactate.toFixed(2) } });
                displayFixedLactatePoints(fixedLactateResultsData);

                // Calculate and display Training Zones
                const maxHr = parsedData[parsedData.length - 1].hr;
                displayTrainingZones({ maxHr, lt1Hr, lt2Hr });

                renderLactateChart();
                renderHrChart();
                renderSrChart();
                renderEfficiencyChart();

                errorDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                errorDiv.textContent = `Error: ${e.message}`;
                errorDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                efficiencyResultsDiv.classList.add('hidden');
                document.getElementById('trainingZones').classList.add('hidden');
                lastCalculationData = null;
            }
        });

        function perpendicularDistance(p, a, b) { const { x, y } = p, { x: x1, y: y1 } = a, { x: x2, y: y2 } = b; const A = y2 - y1, B = x1 - x2, C = -A * x1 - B * y1; return Math.abs(A * x + B * y + C) / Math.sqrt(A * A + B * B); }
        function displayResults(t) { document.getElementById('lt1_hr').textContent = t.lt1.hr; document.getElementById('lt1_speed').textContent = t.lt1.speed; document.getElementById('lt1_lactate').textContent = t.lt1.lactate; document.getElementById('lt2_hr').textContent = t.lt2.hr; document.getElementById('lt2_speed').textContent = t.lt2.speed; document.getElementById('lt2_lactate').textContent = t.lt2.lactate; }
        function displayFixedLactatePoints(r) { document.getElementById('hr_2mmol').textContent = r[2].hr; document.getElementById('speed_2mmol').textContent = r[2].speed; document.getElementById('hr_4mmol').textContent = r[4].hr; document.getElementById('speed_4mmol').textContent = r[4].speed; document.getElementById('hr_6mmol').textContent = r[6].hr; document.getElementById('speed_6mmol').textContent = r[6].speed; }

        function displayTrainingZones({ maxHr, lt1Hr, lt2Hr }) {
            const r_max = Math.round(maxHr);
            const r_lt1 = Math.round(lt1Hr);
            const r_lt2 = Math.round(lt2Hr);
            const r_midpoint = Math.round(lt1Hr + (lt2Hr - lt1Hr) / 2);

            // Zone 1: < 70% HR MAX
            const z1_upper = Math.round(r_max * 0.7);
            document.getElementById('zone_t1_hr').textContent = `< ${z1_upper}`;

            // Zone 2: 70% HR MAX - LT1
            document.getElementById('zone_t2_hr').textContent = `${z1_upper} - ${r_lt1}`;

            // Zone 3: LT1 - Midpoint
            document.getElementById('zone_t3_hr').textContent = `${r_lt1} - ${r_midpoint}`;

            // Zone 4: Midpoint - LT2
            document.getElementById('zone_t4_hr').textContent = `${r_midpoint} - ${r_lt2}`;

            // Zone 5: > LT2
            document.getElementById('zone_t5_hr').textContent = `> ${r_lt2}`;
        }

        function displayEfficiency(efficiencyData) {
            const efficiencyBody = document.getElementById('efficiencyBody');
            efficiencyBody.innerHTML = '';
            if (!efficiencyData || efficiencyData.length < 1) return;

            const baselineEfficiency = efficiencyData[0].efficiency;

            const changes = efficiencyData.map((item, index) => {
                if (index === 0) return { ...item, percentChange: 0 };
                const percentChange = ((item.efficiency - baselineEfficiency) / baselineEfficiency) * 100;
                return { ...item, percentChange };
            });

            const maxAbsChange = Math.max(1, ...changes.map(c => Math.abs(c.percentChange)));

            const getPositiveGradientColor = (value, max) => {
                const percentage = max === 0 ? 1 : value / max;
                const hue = 160 + (percentage * 50); // From teal (160) to bright blue (210)
                return `hsl(${hue}, 70%, 50%)`;
            };

            const getNegativeGradientColor = (value, max) => {
                const percentage = max === 0 ? 1 : value / max;
                const hue = 60 - (percentage * 60); // From yellow (60) to red (0)
                return `hsl(${hue}, 70%, 50%)`;
            };

            changes.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 last:border-b-0';

                let barHtml;
                const barWidth = maxAbsChange > 0 ? (Math.abs(item.percentChange) / maxAbsChange) * 100 : 0;
                const displayChange = item.percentChange.toFixed(1);

                if (item.percentChange >= 0) {
                    const barColor = getPositiveGradientColor(item.percentChange, maxAbsChange);
                    barHtml = `
                        <div class="w-1/2 flex justify-end"></div>
                        <div class="w-px h-6 bg-gray-500"></div>
                        <div class="w-1/2 flex justify-start">
                             <div class="h-4 rounded-r-full" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                        </div>
                    `;
                } else {
                    const barColor = getNegativeGradientColor(Math.abs(item.percentChange), maxAbsChange);
                    barHtml = `
                        <div class="w-1/2 flex justify-end">
                             <div class="h-4 rounded-l-full" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                        </div>
                        <div class="w-px h-6 bg-gray-500"></div>
                        <div class="w-1/2 flex justify-start"></div>
                    `;
                }

                row.innerHTML = `
                    <td class="p-3 font-medium text-center">${item.step}</td>
                    <td class="p-3 font-mono text-center">${item.efficiency.toFixed(3)}</td>
                    <td class="p-3 font-mono text-center ${item.percentChange > 0 ? 'text-teal-400' : item.percentChange < 0 ? 'text-red-400' : ''}">
                        ${item.percentChange >= 0 ? '+' : ''}${displayChange}%
                    </td>
                    <td class="p-3">
                        <div class="flex items-center" title="Change from Step 1: ${displayChange}%">
                           ${barHtml}
                        </div>
                    </td>
                `;
                efficiencyBody.appendChild(row);
            });
        }

        function getChartOptions(yAxisLabel) {
            const tickColor = 'rgba(255, 255, 255, 0.3)';
            const labelColor = 'rgba(255, 255, 255, 0.7)';
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Speed (m/s)', font: { size: 14 }, color: labelColor }, ticks: { color: tickColor }, grid: { color: tickColor } },
                    y: { title: { display: true, text: yAxisLabel, font: { size: 14 }, color: labelColor }, ticks: { color: tickColor }, grid: { color: tickColor } }
                },
                plugins: {
                    legend: { labels: { color: labelColor, filter: (i, c) => !i.text.includes('Curve') && !i.text.includes('Line') } },
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: (${c.parsed.x.toFixed(2)}, ${c.parsed.y.toFixed(3)})` } }
                }
            };
        }

        function renderLactateChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions, thresholds } = lastCalculationData;
            const ctx = document.getElementById('lactateChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Blood Lactate (mmol/L)');
            const datasets = [
                { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.lactate })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6, order: 0 },
                { label: '3rd Order Polynomial Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.lactate.predict(s)[1] })), type: 'line', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2, pointRadius: 0, order: 1 },
                { label: 'Line (for ModDMax)', data: [thresholds.modDmaxLine.start, thresholds.modDmaxLine.end], type: 'line', borderColor: 'rgba(192, 132, 252, 0.6)', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, order: 2 },
                { label: 'LT1', data: [{ x: thresholds.lt1.speed, y: thresholds.lt1.lactate }], backgroundColor: 'rgba(45, 212, 191, 1)', borderColor: 'white', borderWidth: 2, pointRadius: 8, order: 3 },
                { label: 'LT2 (ModDMax)', data: [{ x: thresholds.lt2.speed, y: thresholds.lt2.lactate }], backgroundColor: 'rgba(248, 113, 113, 1)', borderColor: 'white', borderWidth: 2, pointRadius: 8, order: 4 }
            ];

            if (lactateChart) { lactateChart.destroy(); }
            lactateChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderHrChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions } = lastCalculationData;
            const ctx = document.getElementById('hrChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Heart Rate (BPM)');
            const datasets = [
                { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.hr })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6 },
                { label: 'HR Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.hr.predict(s)[1] })), type: 'line', borderColor: 'rgba(248, 113, 113, 1)', borderWidth: 2, pointRadius: 0 }
            ];

            if (hrChart) { hrChart.destroy(); }
            hrChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderSrChart() {
            if (!lastCalculationData) return;
            const { parsedData, regressions } = lastCalculationData;
            const ctx = document.getElementById('srChart').getContext('2d');
            const minSpeed = parsedData[0].speed, maxSpeed = parsedData[parsedData.length - 1].speed, speedRange = maxSpeed - minSpeed;

            const options = getChartOptions('Stroke Rate (spm)');
            let datasets = [];
            if (regressions.sr) {
                datasets = [
                    { label: 'Athlete Data', data: parsedData.map(d => ({ x: d.speed, y: d.sr })), backgroundColor: 'rgba(255, 255, 255, 0.7)', pointRadius: 6 },
                    { label: 'SR Curve', data: Array.from({ length: 101 }, (_, i) => minSpeed + i * speedRange / 100).map(s => ({ x: s, y: regressions.sr.predict(s)[1] })), type: 'line', borderColor: 'rgba(45, 212, 191, 1)', borderWidth: 2, pointRadius: 0 }
                ];
            }

            if (srChart) { srChart.destroy(); }
            srChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options });
        }

        function renderEfficiencyChart() {
            if (!lastCalculationData || !lastCalculationData.efficiencyData) {
                if (efficiencyChart) efficiencyChart.destroy();
                efficiencyChart = null;
                return;
            }
            const { parsedData, efficiencyData } = lastCalculationData;
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            const options = getChartOptions('Efficiency Score');
            const datasets = [{
                label: 'Efficiency',
                data: efficiencyData.map((d, i) => ({ x: parsedData[i].speed, y: d.efficiency })),
                borderColor: 'rgba(251, 191, 36, 1)',
                backgroundColor: 'transparent',
                type: 'line',
                pointRadius: 6,
                pointBackgroundColor: 'rgba(251, 191, 36, 0.7)'
            }];
            if (efficiencyChart) { efficiencyChart.destroy(); }
            efficiencyChart = new Chart(ctx, { type: 'line', data: { datasets }, options });
        }

        // Initial setup
        updateTableHeaders(currentTableType);
        populateTable(7);
    </script>
</body>

</html>